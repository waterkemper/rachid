name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          NODE_ENV=production
          PORT=3001
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL=${{ secrets.SENDGRID_FROM_EMAIL }}
          SENDGRID_FROM_NAME=${{ secrets.SENDGRID_FROM_NAME }}
          PAYPAL_CLIENT_ID=${{ secrets.PAYPAL_CLIENT_ID }}
          PAYPAL_CLIENT_SECRET=${{ secrets.PAYPAL_CLIENT_SECRET }}
          PAYPAL_MODE=${{ secrets.PAYPAL_MODE }}
          PAYPAL_WEBHOOK_ID=${{ secrets.PAYPAL_WEBHOOK_ID }}
          PAYPAL_PLAN_ID_MONTHLY=${{ secrets.PAYPAL_PLAN_ID_MONTHLY }}
          PAYPAL_PLAN_ID_YEARLY=${{ secrets.PAYPAL_PLAN_ID_YEARLY }}
          PAYPAL_LIFETIME_AMOUNT=${{ secrets.PAYPAL_LIFETIME_AMOUNT }}
          PAYPAL_PRODUCT_ID=${{ secrets.PAYPAL_PRODUCT_ID }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_S3_BUCKET_NAME=${{ secrets.AWS_S3_BUCKET_NAME }}
          AWS_CLOUDFRONT_DOMAIN=${{ secrets.AWS_CLOUDFRONT_DOMAIN }}
          IMAGE_MAX_WIDTH=${{ secrets.IMAGE_MAX_WIDTH }}
          IMAGE_JPEG_QUALITY=${{ secrets.IMAGE_JPEG_QUALITY }}
          IMAGE_PNG_QUALITY=${{ secrets.IMAGE_PNG_QUALITY }}
          IMAGE_ENABLE_WEBP=${{ secrets.IMAGE_ENABLE_WEBP }}
          VITE_API_URL=${{ secrets.VITE_API_URL }}
          VITE_GOOGLE_CLIENT_ID=${{ secrets.VITE_GOOGLE_CLIENT_ID }}
          EOF

      - name: Copy files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/${{ secrets.EC2_USER }}/rachid"
          rm: false
          strip_components: 0

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/rachid
            
            # Stop existing containers
            docker-compose down || true
            
            # Remove old images (optional, saves space)
            docker image prune -f
            
            # Build and start containers
            docker-compose up -d --build
            
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 30
            
            # Health check
            docker-compose ps
            
            # Check backend health
            curl -f http://localhost:3001/health || exit 1
            
            # Check frontend health
            curl -f http://localhost:8080/health || exit 1
            
            echo "Deployment completed successfully!"

      - name: Cleanup old images
        uses: appleboy/ssh-action@master
        if: always()
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Remove dangling images
            docker image prune -f

